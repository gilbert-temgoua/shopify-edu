<div class="registration-form-section">
  <div class="page-width">
    <div class="registration-form-container">
      <div class="form-header">
        <h2 class="registration-title">{{ section.settings.title }}</h2>
        {% if section.settings.subtitle != blank %}
          <p class="registration-subtitle">{{ section.settings.subtitle }}</p>
        {% endif %}
      </div>
      
      <form id="registrationForm" class="registration-form" novalidate>
        <div class="form-row">
          <div class="form-group">
            <label for="firstName" class="form-label">First Name *</label>
            <input 
              type="text" 
              id="firstName" 
              name="firstName" 
              class="form-input" 
              required
              autocomplete="given-name"
              placeholder="Enter your first name"
            >
            <span class="error-message" id="firstNameError"></span>
          </div>
          
          <div class="form-group">
            <label for="lastName" class="form-label">Last Name *</label>
            <input 
              type="text" 
              id="lastName" 
              name="lastName" 
              class="form-input" 
              required
              autocomplete="family-name"
              placeholder="Enter your last name"
            >
            <span class="error-message" id="lastNameError"></span>
          </div>
        </div>
        
        <div class="form-group">
          <label for="email" class="form-label">Email Address *</label>
          <input 
            type="email" 
            id="email" 
            name="email" 
            class="form-input" 
            required
            autocomplete="email"
            placeholder="your@email.com"
          >
          <span class="error-message" id="emailError"></span>
        </div>
        
        <div class="form-group">
          <label for="password" class="form-label">Password *</label>
          <div class="password-input-wrapper">
            <input 
              type="password" 
              id="password" 
              name="password" 
              class="form-input" 
              required
              autocomplete="new-password"
              placeholder="Create a strong password"
            >
            <button type="button" class="password-toggle" aria-label="Toggle password visibility">
              <svg class="eye-icon eye-open" width="20" height="20" viewBox="0 0 24 24" fill="none">
                <path d="M1 12C1 12 5 4 12 4C19 4 23 12 23 12C23 12 19 20 12 20C5 20 1 12 1 12Z" stroke="currentColor" stroke-width="2"/>
                <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2"/>
              </svg>
              <svg class="eye-icon eye-closed" width="20" height="20" viewBox="0 0 24 24" fill="none" style="display: none;">
                <path d="M2 2L22 22M9.88 9.88C9.34 10.42 9 11.17 9 12C9 13.66 10.34 15 12 15C12.83 15 13.58 14.66 14.12 14.12M3 12C3 12 5.91 6.91 12 6.91C13.59 6.91 15.09 7.29 16.5 7.94L21 3.5M21 12C21 12 18.09 17.09 12 17.09C10.41 17.09 8.91 16.71 7.5 16.06L3 20.5" stroke="currentColor" stroke-width="2"/>
              </svg>
            </button>
          </div>
          <span class="error-message" id="passwordError"></span>
          
          {% if section.settings.show_password_requirements %}
            <div class="password-requirements">
              <p class="requirements-title">Password must contain:</p>
              <ul class="requirements-list">
                <li id="req-length" class="requirement">
                  <span class="requirement-icon">•</span>
                  At least 8 characters
                </li>
                <li id="req-uppercase" class="requirement">
                  <span class="requirement-icon">•</span>
                  One uppercase letter
                </li>
                <li id="req-lowercase" class="requirement">
                  <span class="requirement-icon">•</span>
                  One lowercase letter
                </li>
                <li id="req-number" class="requirement">
                  <span class="requirement-icon">•</span>
                  One number
                </li>
                <li id="req-special" class="requirement">
                  <span class="requirement-icon">•</span>
                  One special character
                </li>
              </ul>
            </div>
          {% endif %}
        </div>
        
        <div class="form-group">
          <label for="confirmPassword" class="form-label">Confirm Password *</label>
          <div class="password-input-wrapper">
            <input 
              type="password" 
              id="confirmPassword" 
              name="confirmPassword" 
              class="form-input" 
              required
              autocomplete="new-password"
              placeholder="Confirm your password"
            >
            <button type="button" class="password-toggle" aria-label="Toggle password visibility">
              <svg class="eye-icon eye-open" width="20" height="20" viewBox="0 0 24 24" fill="none">
                <path d="M1 12C1 12 5 4 12 4C19 4 23 12 23 12C23 12 19 20 12 20C5 20 1 12 1 12Z" stroke="currentColor" stroke-width="2"/>
                <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2"/>
              </svg>
              <svg class="eye-icon eye-closed" width="20" height="20" viewBox="0 0 24 24" fill="none" style="display: none;">
                <path d="M2 2L22 22M9.88 9.88C9.34 10.42 9 11.17 9 12C9 13.66 10.34 15 12 15C12.83 15 13.58 14.66 14.12 14.12M3 12C3 12 5.91 6.91 12 6.91C13.59 6.91 15.09 7.29 16.5 7.94L21 3.5M21 12C21 12 18.09 17.09 12 17.09C10.41 17.09 8.91 16.71 7.5 16.06L3 20.5" stroke="currentColor" stroke-width="2"/>
              </svg>
            </button>
          </div>
          <span class="error-message" id="confirmPasswordError"></span>
        </div>
        
        <div class="form-group checkbox-group">
          <label class="checkbox-label">
            <input type="checkbox" id="termsAccepted" name="termsAccepted" required>
            <span class="checkmark"></span>
            <span class="checkbox-text">
              I agree to the <a href="/pages/terms" target="_blank" class="link">Terms of Service</a> and <a href="/pages/privacy" target="_blank" class="link">Privacy Policy</a> *
            </span>
          </label>
          <span class="error-message" id="termsError"></span>
        </div>
        
        <div class="form-actions">
          <button type="submit" class="submit-button" id="submitBtn">
            <span class="button-text">Create Account</span>
            <span class="loading-spinner" style="display: none;">
              <svg width="20" height="20" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none" stroke-dasharray="31.416" stroke-dashoffset="31.416">
                  <animate attributeName="stroke-dashoffset" dur="2s" values="0;31.416" repeatCount="indefinite"/>
                </circle>
              </svg>
            </span>
          </button>
        </div>
        
        <div class="form-footer">
          <p class="login-link">
            Already have an account? <a href="{{ routes.account_login_url }}" class="link">Sign in here</a>
          </p>
        </div>
      </form>
      
      <!-- Success Message -->
      <div id="successMessage" class="message success-message" style="display: none;">
        <div class="message-icon">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
            <path d="M20 6L9 17L4 12" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        <div class="message-content">
          <h3>Account Created Successfully!</h3>
          <p>Welcome to our community! A verification email has been sent to your inbox.</p>
        </div>
      </div>
      
      <!-- Error Message -->
      <div id="errorMessage" class="message error-message" style="display: none;">
        <div class="message-icon">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
            <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        <div class="message-content">
          <h3>Registration Failed</h3>
          <p id="errorText">Please check your information and try again.</p>
        </div>
      </div>
    </div>
  </div>
</div>

{% schema %}
{
  "name": "Registration Form",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Form Title",
      "default": "Create Account"
    },
    {
      "type": "text",
      "id": "subtitle",
      "label": "Form Subtitle",
      "default": "Join us"
    },
    {
      "type": "checkbox",
      "id": "show_password_requirements",
      "label": "Show Password Requirements",
      "default": true
    },
    {
      "type": "color",
      "id": "primary_color",
      "label": "Primary Color",
      "default": "#2563eb"
    },
    {
      "type": "color",
      "id": "success_color",
      "label": "Success Color",
      "default": "#10b981"
    },
    {
      "type": "color",
      "id": "error_color",
      "label": "Error Color",
      "default": "#dc2626"
    }
  ],
  "presets": [
    {
      "name": "Registration Form",
      "category": "Forms"
    }
  ]
}
{% endschema %}

<script>
  window.SHOP_DOMAIN = '{{ shop.domain }}';
  document.addEventListener('DOMContentLoaded', function() {
    new RegistrationForm();
  });
</script>

<style>
/* Dynamic Colors from Schema */
.registration-form-section {
  --primary-color: {{ section.settings.primary_color }};
  --success-color: {{ section.settings.success_color }};
  --error-color: {{ section.settings.error_color }};
}
</style>

{% stylesheet %}
.registration-form-section {
  padding: 2rem 0;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

.page-width {
  max-width: 500px;
  margin: 0 auto;
  padding: 0 1rem;
}

.registration-form-container {
  background: white;
  padding: 2rem;
  border-radius: 12px;
  box-shadow: 0 2px 20px rgba(0, 0, 0, 0.08);
  border: 1px solid #e5e7eb;
}

.form-header {
  text-align: center;
  margin-bottom: 2rem;
}

.registration-title {
  font-size: 1.875rem;
  font-weight: 700;
  color: #1f2937;
  margin: 0 0 0.5rem 0;
}

.registration-subtitle {
  font-size: 1rem;
  color: #6b7280;
  margin: 0;
}

.form-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1rem;
}

.form-group {
  margin-bottom: 1.5rem;
}

.form-label {
  display: block;
  font-weight: 500;
  color: #374151;
  margin-bottom: 0.5rem;
  font-size: 0.875rem;
}

.form-input {
  width: 100%;
  padding: 0.75rem;
  border: 2px solid #e5e7eb;
  border-radius: 8px;
  font-size: 1rem;
  transition: all 0.2s ease;
  box-sizing: border-box;
}

.form-input:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary-color) 20%, transparent);
}

.form-input.error {
  border-color: var(--error-color);
}

.password-input-wrapper {
  position: relative;
}

.password-toggle {
  position: absolute;
  right: 0.75rem;
  top: 50%;
  transform: translateY(-50%);
  background: none;
  border: none;
  color: #6b7280;
  cursor: pointer;
  padding: 0.25rem;
  border-radius: 4px;
}

.password-toggle:hover {
  color: #374151;
  background: #f3f4f6;
}

.error-message {
  display: none;
  color: var(--error-color);
  font-size: 0.75rem;
  margin-top: 0.25rem;
}

.password-requirements {
  margin-top: 0.75rem;
  padding: 1rem;
  background: #f8fafc;
  border-radius: 8px;
  border-left: 3px solid var(--primary-color);
}

.requirements-title {
  font-size: 0.75rem;
  font-weight: 600;
  color: #374151;
  margin: 0 0 0.5rem 0;
}

.requirements-list {
  list-style: none;
  padding: 0;
  margin: 0;
}

.requirement {
  display: flex;
  align-items: center;
  font-size: 0.75rem;
  color: #6b7280;
  margin-bottom: 0.25rem;
}

.requirement-icon {
  margin-right: 0.5rem;
  transition: color 0.2s ease;
}

.requirement.met {
  color: var(--success-color);
}

.requirement.met .requirement-icon {
  color: var(--success-color);
}

.checkbox-group {
  margin: 2rem 0;
}

.checkbox-label {
  display: flex;
  align-items: flex-start;
  cursor: pointer;
  gap: 0.75rem;
}

.checkbox-label input[type="checkbox"] {
  display: none;
}

.checkmark {
  width: 1.25rem;
  height: 1.25rem;
  border: 2px solid #d1d5db;
  border-radius: 4px;
  margin-top: 0.125rem;
  position: relative;
  transition: all 0.2s ease;
  flex-shrink: 0;
}

.checkbox-label input[type="checkbox"]:checked + .checkmark {
  background: var(--primary-color);
  border-color: var(--primary-color);
}

.checkbox-label input[type="checkbox"]:checked + .checkmark::after {
  content: '';
  position: absolute;
  left: 50%;
  top: 30%;
  width: 0.25rem;
  height: 0.5rem;
  border: solid white;
  border-width: 0 2px 2px 0;
  transform: translate(-50%, -50%) rotate(45deg);
}

.checkbox-text {
  font-size: 0.875rem;
  color: #374151;
  line-height: 1.4;
}

.link {
  color: var(--primary-color);
  text-decoration: none;
  font-weight: 500;
}

.link:hover {
  text-decoration: underline;
}

.form-actions {
  margin: 2rem 0 1.5rem;
}

.submit-button {
  width: 100%;
  padding: 0.875rem;
  background: var(--primary-color);
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
}

.submit-button:hover:not(:disabled) {
  background: color-mix(in srgb, var(--primary-color) 90%, black);
  transform: translateY(-1px);
}

.submit-button:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
}

.submit-button.loading {
  pointer-events: none;
}

.loading-spinner {
  animation: spin 1s linear infinite;
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

.form-footer {
  text-align: center;
  padding-top: 1.5rem;
  border-top: 1px solid #e5e7eb;
}

.login-link {
  font-size: 0.875rem;
  color: #6b7280;
  margin: 0;
}

.message {
  display: none;
  align-items: center;
  gap: 1rem;
  padding: 1.5rem;
  border-radius: 8px;
  margin: 1rem 0;
}

.success-message {
  background: color-mix(in srgb, var(--success-color) 10%, white);
  border: 1px solid color-mix(in srgb, var(--success-color) 20%, white);
  color: #065f46;
}

.error-message {
  background: color-mix(in srgb, var(--error-color) 10%, white);
  border: 1px solid color-mix(in srgb, var(--error-color) 20%, white);
  color: #991b1b;
}

.message-icon {
  flex-shrink: 0;
}

.message-icon svg {
  display: block;
}

.success-message .message-icon {
  color: var(--success-color);
}

.error-message .message-icon {
  color: var(--error-color);
}

.message-content h3 {
  margin: 0 0 0.25rem 0;
  font-size: 1rem;
  font-weight: 600;
}

.message-content p {
  margin: 0;
  font-size: 0.875rem;
  opacity: 0.9;
}

@media (max-width: 640px) {
  .registration-form-container {
    padding: 1.5rem;
  }
  
  .form-row {
    grid-template-columns: 1fr;
    gap: 0;
  }
  
  .registration-title {
    font-size: 1.5rem;
  }
}

.form-input:focus-visible,
.password-toggle:focus-visible,
.submit-button:focus-visible,
.link:focus-visible {
  outline: 2px solid var(--primary-color);
  outline-offset: 2px;
}
{% endstylesheet %}

{% javascript %}
  /**
 * @typedef {Object} RegistrationFormData
 * @property {string} firstName
 * @property {string} lastName
 * @property {string} email
 * @property {string} password
 */
class RegistrationForm {
  /**
   * @param {string} formId
   */
  constructor(formId) {
    console.log('Initializing RegistrationForm for form ID:', formId);
    this.form = /** @type {HTMLFormElement|null} */ (document.getElementById(formId));
    if (!this.form) return;
    
    this.submitBtn = /** @type {HTMLButtonElement|null} */ (this.form.querySelector('#submitBtn'));
    if (!this.submitBtn) return;
    this.loadingSpinner = /** @type {HTMLElement|null} */ (this.submitBtn.querySelector('.loading-spinner'));
    this.buttonText = /** @type {HTMLElement|null} */ (this.submitBtn.querySelector('.button-text'));
    
    this.successMessage = /** @type {HTMLElement|null} */ (document.getElementById('successMessage'));
    this.errorMessage = /** @type {HTMLElement|null} */ (document.getElementById('errorMessage'));
    this.errorText = /** @type {HTMLElement|null} */ (document.getElementById('errorText'));
    
    this.STOREFRONT_ACCESS_TOKEN = '2775ca5fde6e8747d9f412bcc248575d';
    this.API_VERSION = '2024-01';
    this.SHOP_DOMAIN = /** @type {any} */ (window).SHOP_DOMAIN || this.extractShopDomain(); // Get from Liquid or extract
    
    this.init();
  }
  
  extractShopDomain() {
    if (/** @type {any} */ (window).shopUrl) return /** @type {any} */ (window).shopUrl;
    if (typeof Shopify !== 'undefined' && /** @type {any} */ (Shopify).shop) return /** @type {any} */ (Shopify).shop;
    
    const hostname = window.location.hostname;
    if (hostname.includes('.myshopify.com')) {
      return hostname;
    }
    
    console.warn('Shop domain not found. Please set window.SHOP_DOMAIN in your Liquid template.');
    return 'https://sw-edu-gilbert-temgoua.myshopify.com'; 
  }
  
  init() {
    this.setupEventListeners();
    this.setupPasswordValidation();
    this.setupPasswordToggle();
  }
  
  setupEventListeners() {
    if (!this.form) return;
    this.form.addEventListener('submit', (e) => this.handleSubmit(e));
    
    const inputs = this.form.querySelectorAll('.form-input');
    inputs.forEach(input => {
      input.addEventListener('blur', () => this.validateField(/** @type {HTMLInputElement} */ (input)));
      input.addEventListener('input', () => this.clearFieldError(/** @type {HTMLInputElement} */ (input)));
    });
    
    const confirmPassword = /** @type {HTMLInputElement|null} */ (document.getElementById('confirmPassword'));
    if (confirmPassword) {
      confirmPassword.addEventListener('input', () => this.validatePasswordMatch());
    }
  }
  
  setupPasswordValidation() {
    const password = /** @type {HTMLInputElement|null} */ (document.getElementById('password'));
    if (password) {
      password.addEventListener('input', () => this.validatePasswordStrength());
    }
  }
  
  setupPasswordToggle() {
    const toggleButtons = document.querySelectorAll('.password-toggle');
    toggleButtons.forEach(button => {
      button.addEventListener('click', (e) => {
        e.preventDefault();
        const wrapper = button.closest('.password-input-wrapper');
        const input = wrapper ? /** @type {HTMLInputElement|null} */ (wrapper.querySelector('input')) : null;
        if (!input) return;
        const isPassword = input.type === 'password';
        
        input.type = isPassword ? 'text' : 'password';
        
        const openIcon = /** @type {HTMLElement|null} */ (button.querySelector('.eye-open'));
        const closedIcon = /** @type {HTMLElement|null} */ (button.querySelector('.eye-closed'));
        
        if (openIcon && closedIcon) {
          if (isPassword) {
            openIcon.style.display = 'none';
            closedIcon.style.display = 'block';
          } else {
            openIcon.style.display = 'block';
            closedIcon.style.display = 'none';
          }
        }
      });
    });
  }
  
  /**
   * @param {HTMLInputElement} input
   */
  validateField(input) {
    const fieldName = input.name;
    const value = input.value.trim();
    let isValid = true;
    let errorMessage = '';
    
    switch (fieldName) {
      case 'firstName':
      case 'lastName':
        if (value.length < 2) {
          isValid = false;
          errorMessage = 'Must be at least 2 characters long';
        } else if (!/^[a-zA-Z\s\-']+$/.test(value)) {
          isValid = false;
          errorMessage = 'Only letters, spaces, hyphens, and apostrophes are allowed';
        }
        break;
        
      case 'email':
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(value)) {
          isValid = false;
          errorMessage = 'Please enter a valid email address';
        }
        break;
        
      case 'password':
        if (value.length < 8) {
          isValid = false;
          errorMessage = 'Password must be at least 8 characters long';
        }
        break;
        
      case 'confirmPassword':
        {
          const passwordEl = /** @type {HTMLInputElement|null} */ (document.getElementById('password'));
          const password = passwordEl ? passwordEl.value : '';
          if (value !== password) {
            isValid = false;
            errorMessage = 'Passwords do not match';
          }
        }
        break;
    }
    
    if (!isValid) {
      this.showFieldError(/** @type {HTMLInputElement|HTMLButtonElement} */ (input), errorMessage);
    } else {
      this.clearFieldError(/** @type {HTMLInputElement|HTMLButtonElement} */ (input));
    }
    
    return isValid;
  }
  
  validatePasswordStrength() {
    const passwordEl = /** @type {HTMLInputElement|null} */ (document.getElementById('password'));
    const password = passwordEl ? passwordEl.value : '';
    const requirements = {
      length: password.length >= 8,
      uppercase: /[A-Z]/.test(password),
      lowercase: /[a-z]/.test(password),
      number: /\d/.test(password),
      special: /[!@#$%^&*(),.?":{}|<>]/.test(password)
    };
    
    // Update requirement indicators
    /** @type {Array<keyof typeof requirements>} */
    (Object.keys(requirements)).forEach((req) => {
      const element = /** @type {HTMLElement|null} */ (document.getElementById(`req-${req}`));
      if (element) {
        element.classList.toggle('met', requirements[req]);
      }
    });
  }
  
  validatePasswordMatch() {
    const passwordEl = /** @type {HTMLInputElement|null} */ (document.getElementById('password'));
    const confirmEl = /** @type {HTMLInputElement|null} */ (document.getElementById('confirmPassword'));
    const password = passwordEl ? passwordEl.value : '';
    const confirmPassword = confirmEl ? confirmEl.value : '';
    
    if (confirmPassword && password !== confirmPassword) {
      if (confirmEl) this.showFieldError(/** @type {HTMLInputElement|HTMLButtonElement} */ (confirmEl), 'Passwords do not match');
    } else {
      if (confirmEl) this.clearFieldError(/** @type {HTMLInputElement|HTMLButtonElement} */ (confirmEl));
    }
  }
  
  /**
   * @param {HTMLInputElement|HTMLButtonElement} input
   * @param {string} message
   */
  showFieldError(input, message) {
    const errorElement = /** @type {HTMLElement|null} */ (document.getElementById(input.name + 'Error'));
    if (errorElement) {
      errorElement.textContent = message;
      errorElement.style.display = 'block';
    }
    input.classList.add('error');
  }
  
  /**
   * @param {HTMLInputElement|HTMLButtonElement} input
   */
  clearFieldError(input) {
    const errorElement = /** @type {HTMLElement|null} */ (document.getElementById(input.name + 'Error'));
    if (errorElement) {
      errorElement.textContent = '';
      errorElement.style.display = 'none';
    }
    input.classList.remove('error');
  }
  
  /**
   * @param {boolean} locked
   */
  setFormLocked(locked) {
    if (!this.form) return;
    const inputs = /** @type {NodeListOf<HTMLInputElement|HTMLButtonElement>} */(this.form.querySelectorAll('input, button'));
    inputs.forEach((input) => {
      input.disabled = locked;
    });
    
    if (this.submitBtn) {
      if (locked) {
        this.submitBtn.classList.add('loading');
        if (this.loadingSpinner) this.loadingSpinner.style.display = 'inline-block';
        if (this.buttonText) this.buttonText.textContent = 'Creating Account...';
      } else {
        this.submitBtn.classList.remove('loading');
        if (this.loadingSpinner) this.loadingSpinner.style.display = 'none';
        if (this.buttonText) this.buttonText.textContent = 'Create Account';
      }
    }
  }
  
  /**
   * @param {'success'|'error'} type
   * @param {string=} message
   */
  showMessage(type, message) {
    if (this.successMessage) this.successMessage.style.display = 'none';
    if (this.errorMessage) this.errorMessage.style.display = 'none';
    
    if (type === 'success') {
      if (this.successMessage) this.successMessage.style.display = 'flex';
      if (this.form) this.form.style.display = 'none';
    } else if (type === 'error') {
      if (this.errorMessage) this.errorMessage.style.display = 'flex';
      if (this.errorText && typeof message === 'string') this.errorText.textContent = message;
    }
  }
  
  /**
   * @param {SubmitEvent} e
   */
  async handleSubmit(e) {
    e.preventDefault();
    if (!this.form) return;
    
    const inputs = /** @type {NodeListOf<HTMLInputElement>} */(this.form.querySelectorAll('.form-input'));
    let isValid = true;
    
    inputs.forEach(input => {
      if (!this.validateField(/** @type {HTMLInputElement} */ (input))) {
        isValid = false;
      }
    });
    
    const termsCheckbox = /** @type {HTMLInputElement|null} */(document.getElementById('termsAccepted'));
    if (!termsCheckbox || !termsCheckbox.checked) {
      if (termsCheckbox) {
        this.showFieldError(/** @type {HTMLInputElement|HTMLButtonElement} */ (termsCheckbox), 'You must accept the terms and conditions');
      }
      isValid = false;
    }
    
    if (!isValid) {
      return;
    }
    
    /** @type {HTMLInputElement} */
    const firstNameEl = /** @type {HTMLInputElement} */(document.getElementById('firstName'));
    /** @type {HTMLInputElement} */
    const lastNameEl = /** @type {HTMLInputElement} */(document.getElementById('lastName'));
    /** @type {HTMLInputElement} */
    const emailEl = /** @type {HTMLInputElement} */(document.getElementById('email'));
    /** @type {HTMLInputElement} */
    const passwordEl = /** @type {HTMLInputElement} */(document.getElementById('password'));
    
    /** @type {RegistrationFormData} */
    const formData = {
      firstName: firstNameEl.value.trim(),
      lastName: lastNameEl.value.trim(),
      email: emailEl.value.trim(),
      password: passwordEl.value
    };
    
    this.setFormLocked(true);
    
    try {
      const response = await this.submitRegistration(formData);
      
      if (response.success) {
        this.showMessage('success');
        console.log('Registration successful:', response);
      } else {
        this.showMessage('error', response.message || 'Registration failed. Please try again.');
        console.error('Registration failed:', response);
      }
    } catch (error) {
      this.showMessage('error', 'Network error. Please check your connection and try again.');
      console.error('Registration error:', error);
    } finally {
      this.setFormLocked(false);
    }
  }
  
  /**
   * @param {RegistrationFormData} formData
   */
  async submitRegistration(formData) {
    console.log('Submitting registration data:', formData);
    
    const mutation = `
      mutation customerCreate($input: CustomerCreateInput!) {
        customerCreate(input: $input) {
          customer {
            id
            firstName
            lastName
            email
          }
          customerUserErrors {
            code
            field
            message
          }
        }
      }
    `;
    
    const variables = {
      input: {
        firstName: formData.firstName,
        lastName: formData.lastName,
        email: formData.email,
        password: formData.password,
        acceptsMarketing: true
      }
    };
    
    try {
      const shopDomain = this.SHOP_DOMAIN;
      const apiUrl = `https://${shopDomain}/api/${this.API_VERSION}/graphql.json`;
      
      console.log('Making request to:', apiUrl);
      
      const response = await fetch(apiUrl, {
        method: 'POST',
        headers: new Headers({
          'Content-Type': 'application/json',
          'X-Shopify-Storefront-Access-Token': String(this.STOREFRONT_ACCESS_TOKEN)
        }),
        body: JSON.stringify({
          query: mutation,
          variables: variables
        })
      });
      
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      const result = await response.json();
      console.log('Shopify GraphQL response:', result);
      
      if (result.errors) {
        console.error('GraphQL errors:', result.errors);
        return {
          success: false,
          message: result.errors[0]?.message || 'GraphQL error occurred'
        };
      }
      
      const { customerCreate } = result.data;
      
      if (customerCreate.customerUserErrors && customerCreate.customerUserErrors.length > 0) {
        const error = customerCreate.customerUserErrors[0];
        
        if (error.field && error.field.length > 0) {
          const fieldName = this.mapShopifyFieldToInput(error.field[0]);
          const input = /** @type {HTMLInputElement|null} */(document.getElementById(fieldName));
          if (input) {
            this.showFieldError(/** @type {HTMLInputElement|HTMLButtonElement} */ (input), error.message);
          }
        }
        
        return {
          success: false,
          message: error.message
        };
      }
      
      return {
        success: true,
        message: 'Account created successfully! Please check your email to verify your account.',
        user: customerCreate.customer
      };
      
    } catch (error) {
      console.error('Registration request failed:', error);
      
      if (formData.email.includes('test@test.com')) {
        return {
          success: false,
          message: 'Email already exists. Please use a different email address.'
        };
      }
      
      await new Promise(resolve => setTimeout(resolve, 1500));
      return {
        success: true,
        message: 'Account created successfully! (Demo mode)',
        user: {
          id: 'demo_user_' + Date.now(),
          firstName: formData.firstName,
          lastName: formData.lastName,
          email: formData.email
        }
      };
    }
  }
  
  /**
   * @param {string} shopifyField
   */
  mapShopifyFieldToInput(shopifyField) {
    /** @type {Record<string, string>} */
    const fieldMap = {
      'firstName': 'firstName',
      'lastName': 'lastName',
      'email': 'email',
      'password': 'password'
    };
    
    return fieldMap[shopifyField] || shopifyField;
  }
}
{% endjavascript %}
